{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="container bg-container-dark text-light">
        <div class="row">
            <div class="col-12 col-md-10 text-center text-md-left my-1">
                <h2><strong>bundle</strong></h2>
            </div>
        </div>
        <hr class="bg-light"> 
        <div class="row mt-5">
            <div class="col-10 offset-1">
                {{ bundle.name }}
            </div>
        </div>
        <div class="row mt-5">
            <div class="col-10 offset-1">
                <form action="" id="item-formset">
                    {% csrf_token %}
                    {% for form in formset %}
                        <div class="row my-auto align-items-center formset-row">
                            <div class="col-2 text-center">
                                <img src="" id="img-{{ forloop.counter0 }}" alt="" class="cart-img border border-light rounded-3">
                            </div>
                            <div class="col-5">
                                {{ form.product|as_crispy_field }}
                            </div>
                            <div class="col-2">
                                {{ form.item_qty|as_crispy_field }}
                            </div>
                            <div class="col-1"><a href="#" class="btn btn-danger remove-form mb-3" id="remove-{{ forloop.counter0 }}"><i class="fas fa-trash"></i></a></div>
                            <div class="col-10">
                                <hr class="bg-light">
                            </div>
                        </div>
                    {% endfor %}
                    <div class="col-3 offset-9"><a href="#" class="btn btn-warning add-form mb-3"><i class="fas fa-plus"></i> add new product</a></div>
                    <div class="row mt-5">
                        <div class="col-10 offset-1 text-center">
                            <button type="submit" class="btn btn-warning text-uppercase">add bundle to cart</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block postloadjs %}
{{ block.super }}
<script>    
    $(document).ready(function(){
        $('#item-formset').find('select').each(function(index) {
            getImage(function(output){
                $('#img-' + index).attr("src", output);
            }, this.value);
        });
        
        $('#item-formset').find('select').on('change', function(e)  {
            var selected = $(this).attr('name').split('-')[1];
            getImage(function(output){
                $('#img-' + selected).attr("src", output);
            }, this.value);
        });

        function getImage(handleData, p_id) {
            $.get({
                url: '/bundle/serveimage/' + p_id,
                success: function (response) {              
                    handleData(response);
                },
                error: function () {
                    handleData(response);
                }
            });
        }

        function cloneRow(selector, formsCount) {
            var newElem = $(selector).clone(true);

            var productDiv = newElem.find('#div_id_form-0-product').attr('id', '#div_id_form-' + formsCount + '-product');
            var qtyDiv = newElem.find('#div_id_form-0-item_qty').attr('id', '#div_id_form-' + formsCount + '-item_qty');
           
            var productSelect = productDiv.find('select').first();
            var qtySelect = qtyDiv.find('input').first();

            $(newElem).find('img').attr('id', 'img-' + formsCount);
            $(newElem).find('img').attr('src', '');
            $(productSelect).attr('id','id_form-'+ formsCount +'-product');
            $(productSelect).attr('name','form-'+ formsCount +'-product');
            $(productSelect).find('option:eq(0)').prop('selected', true);
            $(qtySelect).attr('id','id_form-'+ formsCount + '-item_qty');
            $(qtySelect).attr('name','form-'+ formsCount + '-item_qty');
            $(qtySelect).attr('value', "1");
            $(newElem).find('#remove-0').attr('id', 'remove-' + formsCount);

            $('.formset-row').last().after(newElem);
        }

        $('.add-form').on('click', function(e) {
            var formsCount = $('.formset-row').length;
            console.log(formsCount);
            cloneRow($('.formset-row').first(), formsCount);
        });

    });
</script>
{% endblock %}